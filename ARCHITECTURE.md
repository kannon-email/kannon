# Kannon Architecture

## Introduction

Kannon is a cloud-native, scalable SMTP mail sender designed for Kubernetes and modern infrastructure. It provides a gRPC API for sending emails, template management, and statistics, and uses NATS for internal messaging between its modular workers and services. Persistence is handled via PostgreSQL.

## Module Overview

### Core Modules

#### `cmd/`

- Application entrypoint and CLI. Handles configuration, service startup, and orchestrates which components (API, SMTP, sender, dispatcher, etc.) are run.

#### `internal/x/container/`

- Dependency injection container. Manages singletons for DB, NATS, and other shared resources.

#### `internal/db/`

- Database access layer (generated by sqlc). Contains models and queries for all main tables: domains, messages, sending_pool_emails, templates, stats, stats_keys.

#### `internal/mailbuilder/`

- Responsible for building and signing emails (DKIM), rendering templates, and preparing messages for sending. Adds tracking links and pixels. Supports custom headers for overriding the visible To/Cc mail headers independently of the SMTP envelope recipient.

#### `internal/pool/`

- Manages the sending pool (queue) of emails. Handles scheduling, rescheduling, and cleaning up emails in the pool.

#### `internal/publisher/`

- Abstraction for publishing messages to NATS (emails to be sent, stats, etc.).

#### `internal/runner/`

- Utility for running background loops/workers with error handling and timing.

#### `internal/smtp/`

- Low-level SMTP sending logic. Handles direct SMTP delivery, error handling, and MX lookups.

#### `internal/statssec/`

- Handles secure generation and verification of tracking tokens for opens/clicks (JWT-based), and manages stats keys.

#### `internal/templates/`

- Manages email templates: CRUD, transient templates, and template lookup.

#### `internal/utils/`

- Utility functions for email, NATS, and general helpers.

#### `internal/domains/`

- Manages sender domains and DKIM keys.

### Service/Worker Modules (`pkg/`)

#### `pkg/api/`

- gRPC API server. Exposes Admin, Mailer, and Stats APIs for domain, template, mail, and stats management.

#### `pkg/api/adminapi/`

- Implements the Admin API: domain and template management.

#### `pkg/api/mailapi/`

- Implements the Mailer API: handles SendHTML/SendTemplate requests, validates auth, and enqueues emails.

#### `pkg/api/statsapi/statsv1/`

- Implements the Stats API: exposes stats queries.

#### `pkg/bump/`

- Handles HTTP endpoints for open/click tracking. Publishes stats to NATS.

#### `pkg/dispatcher/`

- Worker that pulls scheduled emails from the pool, builds messages, and publishes them to NATS for sending. Listens for delivery/bounce/error events from NATS and updates the pool accordingly.

#### `pkg/sender/`

- Worker that consumes emails to send from NATS, performs SMTP delivery, and publishes delivery/bounce/error stats back to NATS.

#### `pkg/smtp/`

- Runs the SMTP server, accepts incoming SMTP messages, and publishes bounce events to NATS.

#### `pkg/stats/`

- Worker that consumes stats events from NATS and persists them to the database.

#### `pkg/validator/`

- Worker that validates emails in the pool before scheduling for sending. Publishes accepted/rejected stats to NATS.

## API Key Security

### Storage Model

API keys are stored securely: only a SHA-256 hash and an 8-character prefix are persisted. The plaintext key is returned once at creation time and never stored.

The `api_keys` table contains:

| Column          | Description                                      |
| --------------- | ------------------------------------------------ |
| `id`            | Unique key identifier (prefixed with `key_`)     |
| `key_hash`      | SHA-256 hash of the full plaintext key            |
| `key_prefix`    | First 8 characters for display/identification     |
| `domain`        | Associated sender domain                         |
| `name`          | Human-readable key name                          |
| `is_active`     | Whether the key can be used for authentication    |
| `expires_at`    | Optional expiration timestamp                    |
| `deactivated_at`| Timestamp when the key was deactivated            |
| `created_at`    | Timestamp when the key was created                |

### Hashing

Keys are hashed at the application level using SHA-256 (`internal/apikeys/key.go:HashKey`). The hash is computed once during key creation and stored in `key_hash`. During authentication, the service layer hashes the incoming plaintext key and passes the hash to the repository for lookup.

### Authentication Flow

1. Client sends a request to the Mailer gRPC API with Basic auth credentials (domain + API key)
2. The service layer hashes the plaintext key with `HashKey()`
3. The repository looks up the key by domain and hash
4. The service validates that the key is active and not expired

### Security Measures

- **Timing-attack prevention**: The database lookup is always performed, even for invalid key formats, to avoid leaking whether a key exists
- **Generic error messages**: Authentication failures return the same error regardless of the reason (key not found, inactive, or expired)
- **Key masking**: Only the 8-character prefix is exposed in API responses; the full key and hash are never returned
- **Optional expiration**: Keys can have an expiration date, after which they are no longer valid
- **Irreversible deactivation**: Once deactivated, a key cannot be re-activated

### Key Lifecycle

1. **Generation**: `NewAPIKey()` generates a random key, computes its SHA-256 hash and prefix
2. **Storage**: The hash and prefix are persisted; the plaintext key is returned to the caller once
3. **Authentication**: Incoming keys are hashed by the service and matched against stored hashes
4. **Deactivation**: Keys can be deactivated via the Admin API (irreversible)

## NATS Streams, Topics, and Consumers

Kannon uses NATS JetStream for reliable, decoupled messaging between its modules. The main streams and topics are:

### Streams and Topics

| Stream/Topic           | Description                    | Publishers (Modules) | Consumers (Modules) |
| ---------------------- | ------------------------------ | -------------------- | ------------------- |
| kannon.sending         | Emails to be sent via SMTP     | Dispatcher           | Sender              |
| kannon.stats.accepted  | Email accepted for sending     | Validator            | Stats               |
| kannon.stats.rejected  | Email rejected (invalid, etc.) | Validator            | Stats               |
| kannon.stats.delivered | Email delivered successfully   | Sender               | Stats               |
| kannon.stats.bounced   | Email bounced                  | Sender, SMTP Server  | Stats               |
| kannon.stats.open      | Email opened (tracking pixel)  | Bump                 | Stats               |
| kannon.stats.click     | Link clicked in email          | Bump                 | Stats               |
| kannon.bounce          | Bounce events from SMTP server | SMTP Server          | Dispatcher, Stats   |

### Example NATS JetStream Configuration

```yaml
streams:
  - name: kannon_sending
    subjects: ["kannon.sending"]
    retention: limits
    max_msgs: 100000
    max_age: 72h
  - name: kannon_stats
    subjects: ["kannon.stats.*"]
    retention: limits
    max_msgs: 100000
    max_age: 168h
  - name: kannon_bounce
    subjects: ["kannon.bounce"]
    retention: limits
    max_msgs: 10000
    max_age: 168h
```

### Module Interactions with NATS

- **Dispatcher**: Publishes to `kannon.sending`, listens to `kannon.bounce` and delivery/bounce/error events from NATS.
- **Sender**: Consumes from `kannon.sending`, publishes to `kannon.stats.delivered`, `kannon.stats.bounced`, etc.
- **Validator**: Publishes to `kannon.stats.accepted` and `kannon.stats.rejected`.
- **Bump**: Publishes to `kannon.stats.open` and `kannon.stats.click`.
- **Stats**: Consumes all `kannon.stats.*` topics.
- **SMTP Server**: Publishes to `kannon.bounce` and `kannon.stats.bounced`.

### NATS Messaging Diagram

```mermaid
flowchart TD
    subgraph NATS
        SENDING["kannon.sending"]
        STATS["kannon.stats.*"]
        BOUNCE["kannon.bounce"]
    end
    Dispatcher -- "publish" --> SENDING
    SENDING -- "consume" --> Sender
    Sender -- "publish" --> STATS
    Validator -- "publish" --> STATS
    Bump -- "publish" --> STATS
    SMTPServer -- "publish" --> BOUNCE
    BOUNCE -- "consume" --> Dispatcher
    BOUNCE -- "consume" --> Stats
    STATS -- "consume" --> Stats
```

## Architecture Diagram

```mermaid
flowchart TD
    subgraph Core
        API["gRPC API"]
        SMTP["SMTP Server"]
        Sender["Sender"]
        Dispatcher["Dispatcher"]
        Verifier["Verifier"]
        Bounce["Bounce"]
        Stats["Stats"]
    end
    DB[(PostgreSQL)]
    NATS[(NATS)]
    API <--> DB
    Dispatcher <--> DB
    Sender <--> DB
    Verifier <--> DB
    Stats <--> DB
    Bounce <--> DB
    API <--> NATS
    Sender <--> NATS
    Dispatcher <--> NATS
    SMTP <--> NATS
    Stats <--> NATS
    Verifier <--> NATS
    Bounce <--> NATS
```

## API and NATS Message Flows

### 1. Email Submission (API)

- Client calls the gRPC Mailer API (`SendHTML` or `SendTemplate`).
- API authenticates the domain, processes the template, and enqueues recipients into the sending pool (DB).

### 2. Validation (Verifier)

- The Verifier worker pulls emails from the pool with status `to_validate`.
- Validates email addresses. If valid, marks as `scheduled` and publishes an `accepted` stat to NATS. If invalid, cleans from pool and publishes a `rejected` stat.

### 3. Dispatching (Dispatcher)

- The Dispatcher pulls `scheduled` emails from the pool, builds the email (DKIM, tracking, etc.), and publishes them to NATS (`kannon.sending`).
- Listens for delivery, bounce, and error events from NATS and updates the pool accordingly.

### 4. Sending (Sender)

- The Sender worker consumes emails from NATS (`kannon.sending`), performs SMTP delivery, and publishes delivery/bounce/error stats to NATS (`kannon.stats.*`).

### 5. SMTP Server

- Accepts incoming SMTP messages (for bounces, etc.), parses them, and publishes bounce events to NATS.

### 6. Tracking (Bump)

- HTTP endpoints for open/click tracking. When triggered, verifies tokens and publishes open/click stats to NATS.

### 7. Stats Collection

- The Stats worker consumes all stats events from NATS (`kannon.stats.*`) and persists them to the database.

### 8. Admin & Stats APIs

- Admin API: Domain and template management (CRUD, key rotation, etc.).
- Stats API: Query delivery, open, click, and bounce statistics.

---

This architecture enables scalable, decoupled email delivery and analytics, with clear separation of concerns and robust observability via stats and events.
